<!DOCTYPE html>
<html>
<head>
  <title>Privat Webbchatt</title>
  <link rel="stylesheet" href="style.css" /> 
  <audio id="notification-sound" src="notify.mp3" preload="auto"></audio>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div id="user-list">
    <h3>Anv칛ndare</h3>
    <ul id="users"></ul>
  </div>
  <div id="chat">
    <h3 id="chat-with">V칛lj en anv칛ndare att chatta med</h3>
    <ul id="messages"></ul>
    <form id="form" action="">
      <input id="input" autocomplete="off" placeholder="Skriv meddelande..." disabled />
      <button id="send" disabled>Skicka</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
<script>
  let myUsername = '';
  let selectedUser = null;

  // Fr친ga efter anv칛ndarnamn direkt n칛r sidan laddas
  while (!myUsername) {
    myUsername = prompt('Ange ditt anv칛ndarnamn:');
  }

  // Initiera socket med reconnect-inst칛llningar
  const socket = io({
    reconnectionAttempts: 5,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    timeout: 20000,
  });

  // Skicka anv칛ndarnamn n칛r ansluten (f칬rsta g친ngen & reconnect)
  function setUsername() {
    socket.emit('set username', myUsername);
  }
  socket.on('connect', () => {
    console.log('Ansluten till servern');
    setUsername();
  });

  socket.on('disconnect', (reason) => {
    console.log('Fr친nkopplad:', reason);
    if (reason === 'io server disconnect') {
      socket.connect();
    }
  });

  socket.on('connect_error', (error) => {
    console.log('Anslutningsfel:', error);
  });

  const usersList = document.getElementById('users');
  const messages = document.getElementById('messages');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const chatWith = document.getElementById('chat-with');

  // Visa anv칛ndarlistan
  socket.on('user list', (usernames) => {
    usersList.innerHTML = '';
    usernames.forEach(username => {
      if (username === myUsername) return;
      const li = document.createElement('li');
      li.textContent = username;
      li.classList.add('user');
      if (username === selectedUser) li.classList.add('selected');
      li.onclick = () => {
        selectedUser = username;
        chatWith.textContent = `Chatta med: ${selectedUser}`;
        input.disabled = false;
        sendBtn.disabled = false;
        messages.innerHTML = '';
        updateUserList();
      };
      usersList.appendChild(li);
    });
  });

  function updateUserList() {
    Array.from(usersList.children).forEach(li => {
      li.classList.toggle('selected', li.textContent === selectedUser);
    });
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (input.value && selectedUser) {
      socket.emit('private message', {
        to: selectedUser,
        message: input.value
      });
      addMessage(`Du till ${selectedUser}: ${input.value}`);
      input.value = '';
    }
  });

  // Visa privata meddelanden
  socket.on('private message', ({ from, message }) => {
    addMessage(`${from} till dig: ${message}`);

    // 游댒 Notifiering om meddelandet inte 칛r fr친n aktiv anv칛ndare
    if (from !== selectedUser) {
      const audio = document.getElementById('notification-sound');
      if (audio) audio.play();

      const li = Array.from(usersList.children).find(li => li.textContent === from);
      if (li) {
        li.classList.add('notify');
        setTimeout(() => li.classList.remove('notify'), 2000);
      }
    }
  });

  function addMessage(msg) {
    const li = document.createElement('li');
    li.textContent = msg;
    messages.appendChild(li);
    messages.scrollTop = messages.scrollHeight;
  }
</script>

</body>
</html>
